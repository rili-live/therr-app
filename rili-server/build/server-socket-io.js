!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var o=t();for(var r in o)("object"==typeof exports?exports:e)[r]=o[r]}}(global,function(){return function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s="RRgj")}({"1hBF":function(e,t,o){global,e.exports=function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s="Sxyf")}({Sxyf:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=((e,t,o,...r)=>{if(e){const e=0!==o?`<at:${o||Date.now()}>`:"";for(let o=0;o<r.length;o++)t?console.info(`${t}${e}:`,r[o]):console.info(`LOG${e}:`,r[o])}})}})},"2apR":function(e,t,o){global,e.exports=function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s="XDo8")}({XDo8:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=((e,t)=>(o,r)=>{o&&t(o),e(r)})}})},"2lJc":function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=(e=>{const t=[];return Object.keys(e).filter(t=>1!==e[t].length||t!==Object.keys(e[t].sockets)[0]).forEach(o=>t.push({roomKey:o,length:e[o].length,sockets:Object.keys(e[o].sockets).map(t=>({socketId:t,active:e[o].sockets[t]}))})),t})},"6T5q":function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=o("obyI"),n=o("D1nh");t.default=class{constructor(e){this.client=e.client,this.redisHelper=new n.default(this.client)}create(e){const t=Object.assign({},{app:e.app,socketId:e.socketId,ip:e.ip.toString(),ttl:e.ttl||r.socket.userSocketSessionExpire,data:JSON.stringify(e.data)});return this.redisHelper.storeUser(t).then(()=>t)}get(e){return this.redisHelper.getUser(e)}}},"7WL4":function(e,t){e.exports=require("https")},D1nh:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=o("2apR"),n=o("obyI");t.default=class{constructor(e){this.storeUser=(e=>new Promise((t,o)=>{this.client.setex(e.socketId,e.ttl||n.socket.userSocketSessionExpire,e.data,r.default(t,o))})),this.getUser=(e=>new Promise((t,o)=>{this.client.get(e,r.default(t,o))})),this.client=e}}},"F+p8":function(e,t){e.exports=require("socket.io")},KEll:function(e,t){e.exports=require("http")},RRgj:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=o("ZEFf"),n=o("mw/K"),s=(o("KEll"),o("7WL4")),i=o("TM0L"),u=o("F+p8"),l=o("xpYa"),c=o("1hBF"),a=o("obyI"),f=o("6T5q"),d=o("2lJc"),p="withAllLogs"===process.argv[2],m="withLogs"===process.argv[2],b="withRedisLogs"===process.argv[2]||p,y="withSocketLogs"===process.argv[2]||p||b,S=[{host:a.production.redisHost,port:a.production.redisPubPort},{host:a.production.redisHost,port:a.production.redisSubPort}],O=new i(S[0].port,S[0].host,{connectionName:"redisSocketPub",lazyConnect:!0}),h=new f.default({client:O}),g=new i(S[0].port,S[0].host,{connectionName:"redisSocketSub",lazyConnect:!0}),_=[O.connect(),g.connect()];Promise.all(_).then(e=>{b&&O.monitor().then(function(e){e.on("monitor",function(e,t,o,r){c.default(!0,"REDIS_PUB_LOG",e,`Source: ${o}, Database: ${r}`,...t)})}),v()});const v=()=>{let e,t=r();{let o={key:n.readFileSync("/etc/letsencrypt/live/rili.live/privkey.pem"),cert:n.readFileSync("/etc/letsencrypt/live/rili.live/fullchain.pem")};e=s.createServer(o,t)}let o=e.listen(a.production.socketPort),i=u(o,{pingInterval:a.socket.pingInterval,pingTimeout:a.socket.pingTimeout});const f=l({pubClient:O,subClient:g});i.adapter(f),f.pubClient.on("error",e=>{c.default(b,"REDIS_PUB_CLIENT_ERROR",null,e)}),f.subClient.on("error",e=>{c.default(b,"REDIS_SUB_CLIENT_ERROR",null,e)}),f.subClient.on("subscribe",(e,t)=>{c.default(b,"REDIS_SUB_CLIENT",null,`Subscribed to ${e}. Now subscribed to ${t} channel(s).`)}),f.subClient.on("message",(e,t)=>{c.default(b,"REDIS_SUB_CLIENT",null,`Message from channel ${e}: ${t}`)}),i.on("connection",e=>{c.default(y,"SOCKET_IO_LOGS",null,"NEW CONNECTION..."),c.default(y,"SOCKET_IO_LOGS",null,`All Rooms: ${JSON.stringify(d.default(i.sockets.adapter.rooms))}`),e.emit("rooms:list",JSON.stringify(d.default(i.sockets.adapter.rooms))),e.on("room.join",t=>{Object.keys(e.rooms).filter(t=>t!==e.id).forEach(o=>{e.broadcast.to(o).emit("event",`${t.userName} left the room`),e.leave(o)}),setTimeout(()=>{e.join(t.roomName,()=>{e.handshake&&e.handshake.headers&&e.handshake.headers.host&&h.create({app:"riliChat",socketId:e.id,ip:e.handshake.headers.host.split(":")[0],ttl:18e5,data:{userName:t.userName}}).then(t=>{e.emit("session:message",t)}).catch(e=>{c.default(b,"REDIS_SESSION_ERROR",null,e)}),c.default(y,"SOCKET_IO_LOGS",null,`User, ${t.userName} with socketId ${e.id}, joined room ${t.roomName}`),c.default(y,"SOCKET_IO_LOGS",null,`${t.userName}'s Current Rooms: ${JSON.stringify(e.rooms)}`),e.emit("event",`You joined room ${t.roomName}`),e.broadcast.to(t.roomName).emit("event",`${t.userName} joined room ${t.roomName}`)})},0)}),e.on("event",t=>{c.default(m,"EVENT",null,t),t.message?(e.emit("message",`You: ${t.message}`),e.broadcast.to(t.roomName).emit("message",`${t.userName}: ${t.message}`),c.default(y,"SOCKET_IO_LOGS",null,`${t.userName} said: ${t.message}`)):(e.emit("message","You said hello."),e.broadcast.to(t.roomName).emit("message",`${t.userName} says hello!`),c.default(y,"SOCKET_IO_LOGS",null,`${t.userName} says hello!`))}),e.on("disconnecting",t=>{c.default(y,"SOCKET_IO_LOGS",null,`DISCONNECTING... ${t}`),j(e)})})},j=e=>{const t=Object.keys(e.rooms).filter(t=>t!==e.id);t.length&&h.get(e.id).then(o=>{t.forEach(t=>{const r=JSON.parse(o);r&&r.userName&&e.broadcast.to(t).emit("event",`${r.userName} left the room`)})}).catch(e=>{c.default(b,"REDIS_SESSION_ERROR",null,e)})}},TM0L:function(e,t){e.exports=require("ioredis")},ZEFf:function(e,t){e.exports=require("express")},"mw/K":function(e,t){e.exports=require("fs")},obyI:function(e,t){e.exports={development:{redisHost:"127.0.0.1",redisPubPort:17771,redisSubPort:17772,serverPort:7770,socketPort:7771},production:{redisHost:"127.0.0.1",redisPubPort:17771,redisSubPort:17772,serverPort:7770,socketPort:7743},socket:{pingInterval:1e4,pingTimeout:5e3,userSocketSessionExpire:36e5}}},xpYa:function(e,t){e.exports=require("socket.io-redis")}})});