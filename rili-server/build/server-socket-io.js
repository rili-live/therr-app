!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var o=t();for(var n in o)("object"==typeof exports?exports:e)[n]=o[n]}}(global,function(){return function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s="RRgj")}({"/mEI":function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o("1hBF"),r=o("wy2R"),s=o("40N5"),i=o("jxKE"),u=o("RRgj");t.default=((e,t)=>{n.default(u.shouldIncludeLogs,s.SocketClientActionTypes.SEND_MESSAGE,null,t);const o=r(Date.now()).format("MMMM D/YY, h:mma");e.emit("action",{type:s.SocketServerActionTypes.SEND_MESSAGE,data:{roomId:t.roomId,message:{key:Date.now().toString(),time:o,text:`You: ${t.message}`}}}),e.broadcast.to(t.roomId).emit(i.ACTION,{type:s.SocketServerActionTypes.SEND_MESSAGE,data:{roomId:t.roomId,message:{key:Date.now().toString(),time:o,text:`${t.userName}: ${t.message}`}}}),n.default(u.shouldIncludeSocketLogs,"SOCKET_IO_LOGS",null,`${t.userName} said: ${t.message}`)})},"1hBF":function(e,t,o){global,e.exports=function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s="Sxyf")}({Sxyf:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=((e,t,o,...n)=>{if(e){const e=0!==o?`<at:${o||Date.now()}>`:"";for(let o=0;o<n.length;o++)t?console.info(`${t}${e}:`,n[o]):console.info(`LOG${e}:`,n[o])}})}})},"2apR":function(e,t,o){global,e.exports=function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s="XDo8")}({XDo8:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=((e,t)=>(o,n)=>{o&&t(o),e(n)})}})},"2lJc":function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=(e=>{const t=[];return Object.keys(e).filter(t=>1!==e[t].length||t!==Object.keys(e[t].sockets)[0]).forEach(o=>t.push({roomKey:o,length:e[o].length,sockets:Object.keys(e[o].sockets).map(t=>({socketId:t,active:e[o].sockets[t]}))})),t})},"40N5":function(e,t,o){global,e.exports=function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s="jxKE")}({"0sdN":function(e,t,o){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.JOIN_ROOM="CLIENT:JOIN_ROOM",e.LOGIN="CLIENT:LOGIN",e.SEND_MESSAGE="CLIENT:SEND_MESSAGE"}(n||(n={})),t.default=n},jxKE:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o("0sdN");t.SocketClientActionTypes=n.default;const r=o("nwmR");t.SocketServerActionTypes=r.default,t.SERVER_PREFIX="SERVER",t.WEB_CLIENT_PREFIX="CLIENT"},nwmR:function(e,t,o){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.DISCONNECT="SERVER:DISCONNECT",e.JOINED_ROOM="SERVER:JOINED_ROOM",e.OTHER_JOINED_ROOM="SERVER:OTHER_JOINED_ROOM",e.USER_LOGIN_SUCCESS="SERVER:USER_LOGIN_SUCCESS",e.SEND_ROOMS_LIST="SERVER:SEND_ROOMS_LIST",e.SEND_MESSAGE="SERVER:SEND_MESSAGE",e.SESSION_MESSAGE="SERVER:SESSION_MESSAGE"}(n||(n={})),t.default=n}})},"4sAb":function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o("rOLB");t.joinRoom=n.default;const r=o("pRIZ");t.login=r.default;const s=o("/mEI");t.sendMessage=s.default},"6T5q":function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o("AtKU"),r=o("D1nh");t.default=class{constructor(e){this.client=e.client,this.redisHelper=new r.default(this.client)}create(e){const t=Object.assign({},{app:e.app,socketId:e.socketId,ip:e.ip.toString(),ttl:e.ttl||n.production.socket.userSocketSessionExpire,data:JSON.stringify(e.data)});return this.redisHelper.storeUser(t).then(()=>t)}get(e){return this.redisHelper.getUser(e)}}},"7WL4":function(e,t){e.exports=require("https")},AtKU:function(e,t){e.exports={development:{apiPort:7770,baseApiRoute:"http://localhost:7770/api/",baseSocketUrl:"http://localhost:7771",clientPort:7070,googleAnalyticsKey:"",redisHost:"127.0.0.1",redisPubPort:17771,redisSubPort:17772,socketPort:7771,security:{certLocation:"/etc/letsencrypt/live/rili.live/fullchain.pem",keyLocation:"/etc/letsencrypt/live/rili.live/privkey.pem"},socket:{pingInterval:1e4,pingTimeout:5e3,userSocketSessionExpire:36e5}},production:{apiPort:7770,baseApiRoute:"http://rili.live:7770/api/",baseSocketUrl:"https://rili.live:7743",clientPort:7070,googleAnalyticsKey:"",redisHost:"127.0.0.1",redisPubPort:17771,redisSubPort:17772,socketPort:7743,security:{certLocation:"/etc/letsencrypt/live/rili.live/fullchain.pem",keyLocation:"/etc/letsencrypt/live/rili.live/privkey.pem"},socket:{pingInterval:1e4,pingTimeout:5e3,userSocketSessionExpire:36e5}}}},D1nh:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o("2apR"),r=o("AtKU");t.default=class{constructor(e){this.storeUser=(e=>new Promise((t,o)=>{this.client.setex(e.socketId,e.ttl||r.production.socket.userSocketSessionExpire,e.data,n.default(t,o))})),this.getUser=(e=>new Promise((t,o)=>{this.client.get(e,n.default(t,o))})),this.client=e}}},"F+p8":function(e,t){e.exports=require("socket.io")},KEll:function(e,t){e.exports=require("http")},RRgj:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o("ZEFf"),r=o("mw/K"),s=(o("KEll"),o("7WL4")),i=o("TM0L"),u=o("F+p8"),c=o("xpYa"),l=o("4sAb"),a=o("40N5"),d=o("jxKE"),f=o("1hBF"),p=o("AtKU"),S=o("6T5q"),O=o("2lJc");t.rsAppName="riliChat",t.shouldIncludeAllLogs="withAllLogs"===process.argv[2],t.shouldIncludeLogs="withLogs"===process.argv[2],t.shouldIncludeRedisLogs="withRedisLogs"===process.argv[2]||t.shouldIncludeAllLogs,t.shouldIncludeSocketLogs="withSocketLogs"===process.argv[2]||t.shouldIncludeAllLogs||t.shouldIncludeRedisLogs;const y=[{host:p.production.redisHost,port:p.production.redisPubPort},{host:p.production.redisHost,port:p.production.redisSubPort}],m=new i(y[0].port,y[0].host,{connectionName:"redisSocketPub",lazyConnect:!0}),E=new S.default({client:m}),_=new i(y[0].port,y[0].host,{connectionName:"redisSocketSub",lazyConnect:!0}),g=[m.connect(),_.connect()];Promise.all(g).then(e=>{t.shouldIncludeRedisLogs&&m.monitor().then(function(e){e.on("monitor",function(e,t,o,n){f.default(!0,"REDIS_PUB_LOG",e,`Source: ${o}, Database: ${n}`,...t)})}),I()});const I=()=>{let e,o=n();{let t={key:r.readFileSync(p.production.security.keyLocation),cert:r.readFileSync(p.production.security.certLocation)};e=s.createServer(t,o)}let i=e.listen(p.production.socketPort,e=>{const t=p.production.socketPort;f.default(!0,"SOCKET_IO_LOGS",null,`Server running on port, ${t}, with process id ${process.pid}`)}),S=u(i,{pingInterval:p.production.socket.pingInterval,pingTimeout:p.production.socket.pingTimeout});const y=c({pubClient:m,subClient:_});S.adapter(y),y.pubClient.on("error",e=>{f.default(t.shouldIncludeRedisLogs,"REDIS_PUB_CLIENT_ERROR",null,e)}),y.subClient.on("error",e=>{f.default(t.shouldIncludeRedisLogs,"REDIS_SUB_CLIENT_ERROR",null,e)}),y.subClient.on("subscribe",(e,o)=>{f.default(t.shouldIncludeRedisLogs,"REDIS_SUB_CLIENT",null,`Subscribed to ${e}. Now subscribed to ${o} channel(s).`)}),y.subClient.on("message",(e,o)=>{f.default(t.shouldIncludeRedisLogs,"REDIS_SUB_CLIENT",null,`Message from channel ${e}: ${o}`)}),S.on("connection",e=>{f.default(t.shouldIncludeSocketLogs,"SOCKET_IO_LOGS",null,"NEW CONNECTION..."),f.default(t.shouldIncludeSocketLogs,"SOCKET_IO_LOGS",null,`All Rooms: ${JSON.stringify(O.default(S.sockets.adapter.rooms))}`),e.emit(d.ACTION,{type:a.SocketServerActionTypes.SEND_ROOMS_LIST,data:O.default(S.sockets.adapter.rooms)}),e.on(d.ACTION,t=>{t.type===a.SocketClientActionTypes.JOIN_ROOM&&l.joinRoom(e,E,t.data),t.type===a.SocketClientActionTypes.LOGIN&&l.login(e,E,t.data),t.type===a.SocketClientActionTypes.SEND_MESSAGE&&l.sendMessage(e,t.data)}),e.on("disconnecting",o=>{f.default(t.shouldIncludeSocketLogs,"SOCKET_IO_LOGS",null,`DISCONNECTING... ${o}`),b(e)})})},b=e=>{const o=Object.keys(e.rooms).filter(t=>t!==e.id);o.length&&E.get(e.id).then(t=>{o.forEach(o=>{const n=JSON.parse(t);n&&n.userName&&e.broadcast.to(o).emit("event",{type:a.SocketServerActionTypes.DISCONNECT,data:`${n.userName} left the room`})})}).catch(e=>{f.default(t.shouldIncludeRedisLogs,"REDIS_SESSION_ERROR",null,e)})}},TM0L:function(e,t){e.exports=require("ioredis")},ZEFf:function(e,t){e.exports=require("express")},jxKE:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o("qbaI");t.SocketDisconnectReason=n.default,t.ACTION="action"},"mw/K":function(e,t){e.exports=require("fs")},pRIZ:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o("wy2R"),r=o("1hBF"),s=o("40N5"),i=o("jxKE"),u=o("RRgj");t.default=((e,t,o)=>{const c=n(Date.now()).format("MMMM D/YY, h:mma");e.handshake&&e.handshake.headers&&e.handshake.headers.host&&t.create({app:u.rsAppName,socketId:e.id,ip:e.handshake.headers.host.split(":")[0],ttl:18e5,data:{userName:o.userName}}).then(t=>{e.emit(i.ACTION,{type:s.SocketServerActionTypes.SESSION_MESSAGE,data:t})}).catch(e=>{r.default(u.shouldIncludeRedisLogs,"REDIS_SESSION_ERROR",null,e)}),r.default(u.shouldIncludeSocketLogs,"SOCKET_IO_LOGS",null,`User, ${o.userName} with socketId ${e.id}, has logged in.`),e.emit(i.ACTION,{type:s.SocketServerActionTypes.USER_LOGIN_SUCCESS,data:{message:{key:Date.now().toString(),time:c,text:"You have been logged in successfully."},userName:o.userName}})})},qbaI:function(e,t,o){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.transportClose="transport close",e.pingTimeout="ping timeout"}(n||(n={})),t.default=n},rOLB:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o("wy2R"),r=o("1hBF"),s=o("40N5"),i=o("jxKE"),u=o("RRgj");t.default=((e,t,o)=>{const c=n(Date.now()).format("MMMM D/YY, h:mma");Object.keys(e.rooms).filter(t=>t!==e.id).forEach(t=>{e.broadcast.to(t).emit("event",`${o.userName} left the room`),e.leave(t)}),e.join(o.roomId,()=>{r.default(u.shouldIncludeSocketLogs,"SOCKET_IO_LOGS",null,`User, ${o.userName} with socketId ${e.id}, joined room ${o.roomId}`),r.default(u.shouldIncludeSocketLogs,"SOCKET_IO_LOGS",null,`${o.userName}'s Current Rooms: ${JSON.stringify(e.rooms)}`),e.emit(i.ACTION,{type:s.SocketServerActionTypes.JOINED_ROOM,data:{roomId:o.roomId,message:{key:Date.now().toString(),time:c,text:`You joined room ${o.roomId}`},userName:o.userName}}),e.broadcast.to(o.roomId).emit(i.ACTION,{type:s.SocketServerActionTypes.OTHER_JOINED_ROOM,data:{roomId:o.roomId,message:{key:Date.now().toString(),time:c,text:`${o.userName} joined room ${o.roomId}`}}})})})},wy2R:function(e,t){e.exports=require("moment")},xpYa:function(e,t){e.exports=require("socket.io-redis")}})});