!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var o=t();for(var r in o)("object"==typeof exports?exports:e)[r]=o[r]}}(global,function(){return function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s="RRgj")}({"1hBF":function(e,t,o){global,e.exports=function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s="Sxyf")}({Sxyf:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=((e,t,o,...r)=>{if(e){const e=0!==o?`<at:${o||Date.now()}>`:"";for(let o=0;o<r.length;o++)t?console.info(`${t}${e}:`,r[o]):console.info(`LOG${e}:`,r[o])}})}})},"2apR":function(e,t,o){global,e.exports=function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s="XDo8")}({XDo8:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=((e,t)=>(o,r)=>{o&&t(o),e(r)})}})},"2lJc":function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=(e=>{const t=[];return Object.keys(e).filter(t=>1!==e[t].length||t!==Object.keys(e[t].sockets)[0]).forEach(o=>t.push({roomKey:o,length:e[o].length,sockets:Object.keys(e[o].sockets).map(t=>({socketId:t,active:e[o].sockets[t]}))})),t})},"6T5q":function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=o("obyI"),n=o("D1nh");t.default=class{constructor(e){this.client=e.client,this.redisHelper=new n.default(this.client)}create(e){const t=Object.assign({},{app:e.app,socketId:e.socketId,ip:e.ip.toString(),ttl:e.ttl||r.socket.userSocketSessionExpire,data:JSON.stringify(e.data)});return this.redisHelper.storeUser(t).then(()=>t)}get(e){return this.redisHelper.getUser(e)}}},D1nh:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=o("2apR"),n=o("obyI");t.default=class{constructor(e){this.storeUser=(e=>new Promise((t,o)=>{this.client.setex(e.socketId,e.ttl||n.socket.userSocketSessionExpire,e.data,r.default(t,o))})),this.getUser=(e=>new Promise((t,o)=>{this.client.get(e,r.default(t,o))})),this.client=e}}},"F+p8":function(e,t){e.exports=require("socket.io")},RRgj:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=o("ZEFf"),n=o("TM0L"),s=o("F+p8"),i=o("xpYa"),u=o("1hBF"),l=o("obyI"),a=o("6T5q"),c=o("2lJc"),f="withAllLogs"===process.argv[2],d="withLogs"===process.argv[2],p="withRedisLogs"===process.argv[2]||f,m="withSocketLogs"===process.argv[2]||f||p,b=[{host:l.production.redisHost,port:l.production.redisPubPort},{host:l.production.redisHost,port:l.production.redisSubPort}],O=new n(b[0].port,b[0].host,{connectionName:"redisSocketPub",lazyConnect:!0}),S=new a.default({client:O}),y=new n(b[0].port,b[0].host,{connectionName:"redisSocketSub",lazyConnect:!0}),g=[O.connect(),y.connect()];Promise.all(g).then(e=>{p&&O.monitor().then(function(e){e.on("monitor",function(e,t,o,r){u.default(!0,"REDIS_PUB_LOG",e,`Source: ${o}, Database: ${r}`,...t)})}),h()});const h=()=>{let e=r().listen(l.production.socketPort),t=s(e,{pingInterval:l.socket.pingInterval,pingTimeout:l.socket.pingTimeout});const o=i({pubClient:O,subClient:y});t.adapter(o),o.pubClient.on("error",e=>{u.default(p,"REDIS_PUB_CLIENT_ERROR",null,e)}),o.subClient.on("error",e=>{u.default(p,"REDIS_SUB_CLIENT_ERROR",null,e)}),o.subClient.on("subscribe",(e,t)=>{u.default(p,"REDIS_SUB_CLIENT",null,`Subscribed to ${e}. Now subscribed to ${t} channel(s).`)}),o.subClient.on("message",(e,t)=>{u.default(p,"REDIS_SUB_CLIENT",null,`Message from channel ${e}: ${t}`)}),t.on("connection",e=>{u.default(m,"SOCKET_IO_LOGS",null,"NEW CONNECTION..."),u.default(m,"SOCKET_IO_LOGS",null,`All Rooms: ${JSON.stringify(c.default(t.sockets.adapter.rooms))}`),e.emit("rooms:list",JSON.stringify(c.default(t.sockets.adapter.rooms))),e.on("room.join",t=>{Object.keys(e.rooms).filter(t=>t!==e.id).forEach(o=>{e.broadcast.to(o).emit("event",`${t.userName} left the room`),e.leave(o)}),setTimeout(()=>{e.join(t.roomName,()=>{e.handshake&&e.handshake.headers&&e.handshake.headers.host&&S.create({app:"riliChat",socketId:e.id,ip:e.handshake.headers.host.split(":")[0],ttl:18e5,data:{userName:t.userName}}).then(t=>{e.emit("session:message",t)}).catch(e=>{u.default(p,"REDIS_SESSION_ERROR",null,e)}),u.default(m,"SOCKET_IO_LOGS",null,`User, ${t.userName} with socketId ${e.id}, joined room ${t.roomName}`),u.default(m,"SOCKET_IO_LOGS",null,`${t.userName}'s Current Rooms: ${JSON.stringify(e.rooms)}`),e.emit("event",`You joined room ${t.roomName}`),e.broadcast.to(t.roomName).emit("event",`${t.userName} joined room ${t.roomName}`)})},0)}),e.on("event",t=>{u.default(d,"EVENT",null,t),t.message?(e.emit("message",`You: ${t.message}`),e.broadcast.to(t.roomName).emit("message",`${t.userName}: ${t.message}`),u.default(m,"SOCKET_IO_LOGS",null,`${t.userName} said: ${t.message}`)):(e.emit("message","You said hello."),e.broadcast.to(t.roomName).emit("message",`${t.userName} says hello!`),u.default(m,"SOCKET_IO_LOGS",null,`${t.userName} says hello!`))}),e.on("disconnecting",t=>{u.default(m,"SOCKET_IO_LOGS",null,`DISCONNECTING... ${t}`),_(e)})})},_=e=>{const t=Object.keys(e.rooms).filter(t=>t!==e.id);t.length&&S.get(e.id).then(o=>{t.forEach(t=>{const r=JSON.parse(o);r&&r.userName&&e.broadcast.to(t).emit("event",`${r.userName} left the room`)})}).catch(e=>{u.default(p,"REDIS_SESSION_ERROR",null,e)})}},TM0L:function(e,t){e.exports=require("ioredis")},ZEFf:function(e,t){e.exports=require("express")},obyI:function(e,t){e.exports={development:{redisHost:"127.0.0.1",redisPubPort:17771,redisSubPort:17772,serverPort:7770,socketPort:7771},production:{redisHost:"127.0.0.1",redisPubPort:17771,redisSubPort:17772,serverPort:7770,socketPort:7771},socket:{pingInterval:1e4,pingTimeout:5e3,userSocketSessionExpire:36e5}}},xpYa:function(e,t){e.exports=require("socket.io-redis")}})});